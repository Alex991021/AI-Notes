# 语义地图细化 - 纠正标签的空间分布

## 一、纠正标签的空间分布原理

在生成的语义图中，可能会错误地分割一些体素，这些错误分割体素有 2 个主要特征：

- 距离真实物体较远
- 具有较低的密度

这里使用空间推理方法来滤除这些错误（噪声）体素：

1. 首先，查找一个体素 V 的 K 个近邻
2. 计算体素 V 与 K 个近邻之间的平均距离 L
3. 如果平均距离 L 小于某个阈值，则体素 V 被认为是正常体素
4. 如果平均距离 L 大于等于某个阈值，这体素 V 被认为是噪声体素

公式如下：

![](https://dlonng.oss-cn-shenzhen.aliyuncs.com/blog/spatial_distribution.png)

解释下：

- 1 和 0 分别表示正确体素和噪声体素
- $p^v$ 表示当前要判断的体素
- $P_{nn}^{v}$ 表示 $p^v$ 的 K 个最近邻居
- $Avg|p^v - P_{nn}^{v}|$ 表示当前体素和其 K 个最近邻居的平均距离（欧拉距离）
- $\delta_d$ 表示平均距离阈值，需要根据自己的项目做实验确定

这种方法计算量不是很大，对于很大的地图运算速度也还行，性能具有一定优势。

## 二、实现方法

### 2.1 PCL K 近邻滤波器

PCL 的 K 近邻滤波器使用的距离阈值为高斯分布参数：全局距离均值和标准差定义的区间，在区间之外的点视为噪声数据。

-  PCL  [K 近邻滤波器](https://pcl-tutorials.readthedocs.io/en/latest/statistical_outlier.html#statistical-outlier-removal)

问题:

- 这个滤波器能否直接对八叉树体素栅格进行滤波？

### 2.2 自己实现

自己实现的阈值只是单纯的使用欧拉距离：

- 读取 octomap_server 构建的八叉树地图 `map.bt` 文件
- 查找当前体素 V 的 K 近邻：[PCL kdtree](https://pcl-tutorials.readthedocs.io/en/latest/kdtree_search.html#kdtree-search) 和 [Octree-Search](https://pcl-tutorials.readthedocs.io/en/latest/octree.html#octree-search)
- 计算平均欧拉距离 $L_{avg}$
- 根据实验确定平均距离阈值 $\delta_d$
- 如果小于阈值为正常体素，保留下来
- 如果大于等于阈值为噪声体素，从点云集合中删除当前体素 V

问题：

- 如何使用 octomap_server 读取构建的八叉树地图？ - octomap [readBinary](http://octomap.github.io/octomap/doc/classoctomap_1_1OcTree.html#af6f005facc4efe01ce21ae1933c4b3f8)
- 如何使用 PCL 读取八叉树地图？
- 如何用 PCL 对读取的八叉树地图进行 K 近邻搜索？ - 查找 octree 类





## 三、相关问题

- 语义地图是八叉树格式，PCL 点云库能否对八叉树地图进行滤波？
- 细化是在地图完全构建完成后再进行？是的！

