# 语义地图细化 - 移除动态物体运动轨迹

## O、方法调查

### 1 建图后移除

- [DBSCAN 聚类]()

### 2 帧间移除

- [SuMa++](https://github.com/PRBonn/semantic_suma)

## 一、移除动态轨迹方法原理

构建的语义地图中如果有运动车辆，则会存在很长的运动轨迹，需要去除！从构建的地图中导出车辆标签，使用带噪声的空间聚类方法 DBSCAN 来分类动态和静态的车辆点云簇。

因为 DBSCAN 在数量较多的 3D 点云地图上需要很长的计算时间，所以将原 3D 点云地图的 Z 轴全部设置为 0，转化为 2D 的网格地图，进而使用 DBSCAN 可以大大提高速度！


$$
M_{2D}^v(x, y) = M_{3D}^v(x, y, z = 0)
$$


- $M_{2D}^v$ 表示 2D 网格地图
- $M_{3D}^v$ 表示 3D 网格地图

DBSCAN 在 2D 网格聚类运动车辆的原理：**运动的车辆点云相比静止的车辆点云数量多，长度长！**因此可设置点云数量和长度的阈值：

![](https://dlonng.oss-cn-shenzhen.aliyuncs.com/blog/DBSCAN.png)

- $C_i$ 表示要判断的体素簇
- $D_i$ 表示体素簇的数量
- $n_d$ 表示体素簇数量的阈值
- $L_i$ 表示体素簇的长度
- $n_l$ 表示体素簇长度的阈值 

## 二、实现方法

步骤：

- 读取全局语义地图：PCL 还是 Octomap？

- 利用体素标签得到所有的车辆体素簇：？

- 将选择的体素簇的 Z 全部设置为 0

- 计算当前体素簇的数量

- 计算当前体素簇的长度：？

- 比较数量阈值和长度阈值

- 小于 2 个阈值分类为静态车辆

- 大于 2 个阈值分类为动态车辆，将当前体素簇从全局点云中删除？删除单个或一组点云


## 三、Octomap 移除动态轨迹

必须熟悉：

- octomap 库的常用函数的作用和使用方法
- octomap_server 节点的逻辑，在其上增加地图细化的功能！

先学习如何使用 octomap 库，再做修改！octomap_server 内部实现过对地面的检测和滤除，可以参考滤波使用的函数方法！

### 3.1 octomap_server 滤除地面

节点内部设置了是否滤波的开关，开启后使用 PCL 的滤波器对原始点云操作后，再转八叉树！

参考资料（google dynamic objects removal with octomap）：

- [dynamic objects removal with octomap - Google Groups](https://groups.google.com/d/topic/octomap/D9NG7oq1644)
- https://github.com/OctoMap/octomap_mapping/issues/31
- [octomap in dynamic environment](https://answers.ros.org/question/77476/octomap-in-dynamic-environment/)
- [Removing Moving Objects from Point Cloud Scenes](https://www.uni-muenster.de/PRIA/WDIA2012/scientific_program/Paper-Litomisky.pdf)
- [Dynamic Obstacles Rejection for 3D Map ... - IEEE Xplore](https://ieeexplore.ieee.org/iel7/6287639/6514899/08358699.pdf)
- [How to eliminate dynamic object from map while mapping](https://github.com/introlab/rtabmap_ros/issues/269)